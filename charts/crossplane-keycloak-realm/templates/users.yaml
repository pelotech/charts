{{- $providerConfigName := tpl .Values.providerConfig.name $ | required ".Values.providerConfig.name is required" }}
{{- $realmName := tpl .Values.realm.name $ | required ".Values.realm.name is required" }}

{{- range $user := .Values.users }}

{{- $tmp := $user.username | required "$user.username is required" }}
{{- $safeShortUserName := $user.username | replace "." "-" }}
{{- $resourceName := printf "%s--%s" $realmName $safeShortUserName }}
{{- $tmp2 := $user.email | required (printf "$user.%s.email is required" $safeShortUserName) }}
---
apiVersion: user.keycloak.crossplane.io/v1alpha1
kind: User
metadata:
  name: "{{ $resourceName }}"
spec:
  deletionPolicy: Delete
  providerConfigRef:
    name: "{{ $providerConfigName }}"
  forProvider:
    realmIdRef:
      name: "{{ $realmName }}"
    {{- tpl ($user | toYaml) $ | nindent 4 }}
{{- end }}
