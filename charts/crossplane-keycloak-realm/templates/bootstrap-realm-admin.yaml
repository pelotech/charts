{{- if .Values.adminUser.enabled }}
{{- $providerConfigSecretName := tpl .Values.providerConfig.secretName $ | required ".Values.providerConfig.secretName is required" }}
{{- $realmName := tpl .Values.realm.name $ }}
{{- $realmResourceName := printf "%s--realm" $realmName }}
{{- $userResourceName := printf "%s-user--realm-admin" $realmName }}
{{- $roleResourceName := printf "%s-role--realm-admin" $realmName }}
{{- $clientResourceName := printf "%s-oidc-client--realm-management" $realmName }}
---
apiVersion: openidclient.keycloak.m.crossplane.io/v1alpha1
kind: Client
metadata:
  name: "{{ $clientResourceName }}"
  namespace: "{{ .Release.Namespace }}"
spec:
  forProvider:
    accessType: CONFIDENTIAL
    clientId: realm-management
    realmId: "{{ $realmName }}"
    standardFlowEnabled: true
    directAccessGrantsEnabled: true
    serviceAccountsEnabled: true
    import: true
  providerConfigRef: {{- pick (required ".Values.providerConfig is required" .Values.providerConfig) "name" "kind" | toYaml | nindent 4}}
  managementPolicies: [Observe]

---

apiVersion: role.keycloak.m.crossplane.io/v1alpha1
kind: Role
metadata:
  annotations:
    crossplane.io/external-name: realm-admin
  name: "{{ $roleResourceName }}"
  namespace: "{{ .Release.Namespace }}"
spec:
  providerConfigRef: {{- pick (required ".Values.providerConfig is required" .Values.providerConfig) "name" "kind" | toYaml | nindent 4}}
  forProvider:
    description: My Realm Admin Role
    name: realm-admin
    realmIdRef:
      name: "{{ $realmResourceName }}"
    import: true
    clientIdRef:
      name: "{{ $clientResourceName }}"
  managementPolicies: [Observe]

---

apiVersion: user.keycloak.m.crossplane.io/v1alpha1
kind: User
metadata:
  name: "{{ $userResourceName }}"
  namespace: "{{ .Release.Namespace }}"
spec:
  providerConfigRef: {{- pick (required ".Values.providerConfig is required" .Values.providerConfig) "name" "kind" | toYaml | nindent 4}}
  forProvider:
    username: "{{ .Values.adminUser.username }}"
    email: "{{ .Values.adminUser.email }}"
    realmIdRef:
      name: "{{ $realmResourceName }}"

---
apiVersion: user.keycloak.m.crossplane.io/v1alpha1
kind: Roles
metadata:
  name: "{{ $realmName }}-user-role--realm-admin"
  namespace: "{{ .Release.Namespace }}"
spec:
  providerConfigRef: {{- pick (required ".Values.providerConfig is required" .Values.providerConfig) "name" "kind" | toYaml | nindent 4}}
  forProvider:
    realmIdRef:
      name: "{{ $realmResourceName }}"
    userIdRef:
      name: "{{ $userResourceName }}"
    roleIdsRefs:
      - name:  "{{ $roleResourceName }}"

{{- end }}
